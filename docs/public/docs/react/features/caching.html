<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <!-- Basic -->
    <title>Direct Cache Access | Apollo Client Guide</title>
    <meta name="description" content="Read and write functions for fine-grained cache access.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="images/favicon.png" sizes="16x16 32x32 64x64">

    <!-- Social -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://www.apollographql.com/docs/react">
    <meta property="og:title" content="Direct Cache Access | Apollo Client Guide">
    <meta property="og:description" content="Read and write functions for fine-grained cache access.">
    <meta property="og:image" content="">
    <meta name="twitter:card" content="summary_image_large">
    <meta name="twitter:site" content="@apollographql">
    <meta name="twitter:title" content="Direct Cache Access | Apollo Client Guide">
    <meta name="twitter:description" content="Read and write functions for fine-grained cache access.">
    <meta name="twitter:image" content="">

    <!-- Misc -->
    <meta name="google-site-verification" content="" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,300italic,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/docs/react/style/style.css">
  </head>
  <body class="">
    

<div class="nav dark">
  <div class="nav-group">
    <div class="nav-item show-mobile">
      <span class="js-sidebar-toggle ">
        <span class="icon-menu"></span>
      </span>
    </div>
    <div class="nav-item">
      
      <a class="logo-wrapper" href="http://dev.apollodata.com/" title="Apollo Developers"  >
        <img src="../images/logo-apollo-space-left.svg" alt="Apollo" class="logo"/><img src="../images/logo-apollo-subbrands-developers-space.svg" class="logo-subbrand" alt="Developers"/>
      </a>
    </div>
  </div>

  <div class="nav-group right">
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/react"  >
          <span>React</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/angular2"  >
          <span>Angular</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/ios"  >
          <span>iOS</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/android"  >
          <span>Android</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/core"  >
          <span>Vanilla JS</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false separator">
        <a class="link" href="http://dev.apollodata.com/tools"  >
          <span>Server</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="https://medium.com/apollo-stack" target=_new >
          <span>Blog</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/community"  >
          <span>Community</span>
        </a>
      </div>
    
  </div>
</div>

<div class="sidebar">
  <div class="panel">
    <div class="panel-item">
      <a class="" href="../http:/dev.apollodata.com/" title="Apollo"  >
        <span>Apollo Developers</span>
      </a>
    </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/react"  >
          <span>React</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/angular2"  >
          <span>Angular</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/ios"  >
          <span>iOS</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/android"  >
          <span>Android</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/core"  >
          <span>Vanilla JS</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/tools"  >
          <span>Server</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="https://medium.com/apollo-stack" target=_new >
          <span>Blog</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/community"  >
          <span>Community</span>
        </a>
      </div>
    
  </div>

  <div class="sidebar-content">
    <div class="topcap">
      <span class="title-sidebar">Apollo Client Guide</span>
      
    </div>

    

    <ul class="toc">
      
        <li>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../index.html" class="sidebar-link ">
                  <span>Apollo Client</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../basics/integrations.html" class="sidebar-link ">
                  <span>View Integrations</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../basics/setup.html" class="sidebar-link ">
                  <span>Setup and options</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../basics/queries.html" class="sidebar-link ">
                  <span>Queries</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../basics/mutations.html" class="sidebar-link ">
                  <span>Mutations</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../basics/network-layer.html" class="sidebar-link ">
                  <span>Network layer</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../basics/error-handling.html" class="sidebar-link ">
                  <span>Error Handling</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../basics/fragments.html" class="sidebar-link ">
                  <span>Using Fragments</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../basics/subscriptions.html" class="sidebar-link ">
                  <span>Subscriptions</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Features</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="changelog.html" class="sidebar-link ">
                  <span>Changelog</span>
                </a>
              </li>
            
              
              <li class="item-toc  current">
                <a href="" class="sidebar-link  current">
                  <span>Direct Cache Access</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="developer-tooling.html" class="sidebar-link ">
                  <span>Developer tools</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="network-customization.html" class="sidebar-link ">
                  <span></span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="optimistic-ui.html" class="sidebar-link ">
                  <span>Optimistic UI</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="react-native.html" class="sidebar-link ">
                  <span>Integrating with React Native</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="static-typing.html" class="sidebar-link ">
                  <span>Using TypeScript and Flow</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Recipes</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../recipes/authentication.html" class="sidebar-link ">
                  <span>Authentication</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/babel.html" class="sidebar-link ">
                  <span>Precompilation with babel</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/meteor.html" class="sidebar-link ">
                  <span>Meteor</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/pagination.html" class="sidebar-link ">
                  <span>Pagination</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/prefetching.html" class="sidebar-link ">
                  <span>Prefetching data</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/query-splitting.html" class="sidebar-link ">
                  <span>Query Splitting</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/server-side-rendering.html" class="sidebar-link ">
                  <span>Server Side Rendering</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/simple-example.html" class="sidebar-link ">
                  <span>Small Example: Snack</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/webpack.html" class="sidebar-link ">
                  <span>Webpack loader</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Reference</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../reference/index.html" class="sidebar-link ">
                  <span>Title</span>
                </a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </div>
</div>

<div class="content">
  <div class="content-wrapper">
    <div class="header-content">
      <h1 class="title-page">Direct Cache Access</h1>
      
        <div class="subtitle-page">Read and write functions for fine-grained cache access.</div>
      

      <div class="page-actions">
        <div class="actions-group">
          <a class="btn tertiary small round lowercase" href="https://github.com/apollographql/apollo-client/tree/master/docs/source/features/caching.md" target="_blank"><span class="icon-github"></span> <span>Edit on GitHub</span></a>
          
          
        </div>
      </div>
    </div>

    <div class="document-formatting">
      <p>Apollo Client normalizes all of your data so that if any data you previously fetched from your GraphQL server is updated in a later data fetch from your server then your data will be updated with the latest truth from your server.</p>
<p>This normalization process is constantly happening behind the scenes when you call <code>watchQuery</code> or use a view integration library like <a href="http://github.com/apollographql/react-apollo" target="_blank" rel="external"><code>react-apollo</code></a>, but this process is often not enough to describe the updates to your data model as the result of a mutation. For example, if you wanted to add an item to the end of an array fetched by one of your queries. You also might want to read data from the normalized Apollo Client store at a specific id without making another GraphQL server fetch.</p>
<p>To interact directly with your data in the Apollo Client store you may use the methods <code>readQuery</code>, <code>readFragment</code>, <code>writeQuery</code>, and <code>writeFragment</code> that are accessible from the <code>ApolloClient</code> class. This article will teach you how to use these methods to control your data.</p>
<p>If you would like a better understanding of the data normalization process then we recommend reading the <a href="how-it-works.html">“How it works”</a> documentation article. Knowledge around how Apollo Client works is not a prerequisite for using the methods described here, but it may be helpful.</p>
<p>All of the methods we will discuss can be called from the <code>ApolloClient</code> class. Any code demonstration in this article will assume that we have already initialized an instance of <code>ApolloClient</code> and assigned it to the <code>client</code>, and that we have imported the <code>gql</code> tag from <code>graphql-tag</code>. Like so:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; ApolloClient &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"><span class="keyword">import</span> gql <span class="keyword">from</span> <span class="string">'graphql-tag'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123; ... &#125;);</div></pre></td></tr></table></figure>
<h2 id="readquery"><code>readQuery</code></h2>

<p>The <code>readQuery</code> method is very similar to the <a href="apollo-client-api.html#ApolloClient.query"><code>query</code> method on <code>ApolloClient</code></a> except that <code>readQuery</code> will <em>never</em> make a request to your GraphQL server. The <code>query</code> method, on the other hand, may send a request to your server if the appropriate data is not in your cache whereas <code>readQuery</code> will throw an error if the data is not in your cache. <code>readQuery</code> will <em>always</em> read from the cache. You can use <code>readQuery</code> by giving it a GraphQL query like so:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123; todo &#125; = client.readQuery(&#123;</div><div class="line">  query: gql<span class="string">`</span></div><div class="line"><span class="string">    query ReadTodo &#123;</span></div><div class="line"><span class="string">      todo(id: 5) &#123;</span></div><div class="line"><span class="string">        id</span></div><div class="line"><span class="string">        text</span></div><div class="line"><span class="string">        completed</span></div><div class="line"><span class="string">      &#125;</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  `</span>,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>If all of the data needed to fulfill this read is in Apollo Client’s normalized data cache then a data object will be returned in the shape of the query you wanted to read. If not all of the data needed to fulfill this read is in Apollo Client’s cache then an error will be thrown instead, so make sure to only read data that you know you have!</p>
<p>You can also pass variables into <code>readQuery</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123; todo &#125; = client.readQuery(&#123;</div><div class="line">  query: gql<span class="string">`</span></div><div class="line"><span class="string">    query ReadTodo($id: Int!) &#123;</span></div><div class="line"><span class="string">      todo(id: $id) &#123;</span></div><div class="line"><span class="string">        id</span></div><div class="line"><span class="string">        text</span></div><div class="line"><span class="string">        completed</span></div><div class="line"><span class="string">      &#125;</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  `</span>,</div><div class="line">  variables: &#123;</div><div class="line">    id: <span class="number">5</span>,</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>Resources:</strong></p>
<ul>
<li><a href="apollo-client-api.html#ApolloClient.query"><code>ApolloClient#query</code> API documentation</a></li>
<li><a href="apollo-client-api.html#ApolloClient.readQuery"><code>ApolloClient#readQuery</code> API documentation</a></li>
<li><a href="apollo-client-api.html#DataProxy.readQuery"><code>DataProxy#readQuery</code> API documentation</a></li>
</ul>
<h2 id="readfragment"><code>readFragment</code></h2>

<p>This method allows you great flexibility around the data in your cache. Whereas <code>readQuery</code> only allowed you to read data from your root query type, <code>readFragment</code> allows you to read data from <em>any node you have queried</em>. This is incredibly powerful. You use this method as follows:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> todo = client.readFragment(&#123;</div><div class="line">  id: ..., <span class="comment">// `id` is any id that could be returned by `dataIdFromObject`.</span></div><div class="line">  fragment: gql<span class="string">`</span></div><div class="line"><span class="string">    fragment myTodo on Todo &#123;</span></div><div class="line"><span class="string">      id</span></div><div class="line"><span class="string">      text</span></div><div class="line"><span class="string">      completed</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  `</span>,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The first argument is the id of the data you want to read from the cache. That id must be a value that was returned by the <code>dataIdFromObject</code> function you defined when initializing <code>ApolloClient</code>. So for example if you initialized <code>ApolloClient</code> like so:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  ...,</div><div class="line">  dataIdFromObject: <span class="function"><span class="params">object</span> =&gt;</span> object.id,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>…and you requested a todo before with an id of <code>5</code>, then you can read that todo out of your cache with the following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> todo = client.readFragment(&#123;</div><div class="line">  id: <span class="string">'5'</span>,</div><div class="line">  fragment: gql<span class="string">`</span></div><div class="line"><span class="string">    fragment myTodo on Todo &#123;</span></div><div class="line"><span class="string">      id</span></div><div class="line"><span class="string">      text</span></div><div class="line"><span class="string">      completed</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  `</span>,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Most people add a <code>__typename</code> to the id in <code>dataIdFromObject</code>. If you do this then don’t forget to add the <code>__typename</code> when you are reading a fragment as well. So for example your id may be <code>Todo_5</code> and not just <code>5</code>.</p>
</blockquote>
<p>If a todo with that id does not exist in the cache you will get <code>null</code> back. If a todo of that id does exist in the cache, but that todo does not have the <code>text</code> field then an error will be thrown.</p>
<p>The beauty of <code>readFragment</code> is that the todo could have come from anywhere! The todo could have been selected as a singleton (<code>{ todo(id: 5) { ... } }</code>), the todo could have come from a list of todos (<code>{ todos { ... } }</code>), or the todo could have come from a mutation (<code>mutation { createTodo { ... } }</code>). As long as at some point your GraphQL server gave you a todo with the provided id and fields <code>id</code>, <code>text</code>, and <code>completed</code> you can read it from the cache at any part of your code.</p>
<p><strong>Resources:</strong></p>
<ul>
<li><a href="apollo-client-api.html#ApolloClient.readFragment"><code>ApolloClient#readFragment</code> API documentation</a></li>
<li><a href="apollo-client-api.html#DataProxy.readFragment"><code>DataProxy#readFragment</code> API documentation</a></li>
</ul>
<h2 id="writequery-and-writefragment"><code>writeQuery</code> and <code>writeFragment</code></h2>

<p>Not only can you read arbitrary data from the Apollo Client cache, but you can also write any data that you would like to the cache. The methods you use to do this are <code>writeQuery</code> and <code>writeFragment</code>. They will allow you to change data in your local cache, but it is important to remember that <em>they will not change any data on your server</em>. If you reload your environment then changes made with <code>writeQuery</code> and <code>writeFragment</code> will disappear.</p>
<p>These methods have the same signature as their <code>readQuery</code> and <code>readFragment</code> counterparts except they also require an additional <code>data</code> variable. So for example, if you wanted to update the <code>completed</code> flag locally for your todo with id <code>&#39;5&#39;</code> you could execute the following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">client.writeFragment(&#123;</div><div class="line">  id: <span class="string">'5'</span>,</div><div class="line">  fragment: gql<span class="string">`</span></div><div class="line"><span class="string">    fragment myTodo on Todo &#123;</span></div><div class="line"><span class="string">      completed</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  `</span>,</div><div class="line">  data: &#123;</div><div class="line">    completed: <span class="literal">true</span>,</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Any subscriber to the Apollo Client store will instantly see this update and render new UI accordingly.</p>
<blockquote>
<p><strong>Note:</strong> Again, remember that using <code>writeQuery</code> or <code>writeFragment</code> only changes data <em>locally</em>. If you reload your environment then changes made with these methods will no longer exist.</p>
</blockquote>
<p>Or if you wanted to add a new todo to a list fetched from the server, you could use <code>readQuery</code> and <code>writeQuery</code> together.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> query = gql<span class="string">`</span></div><div class="line"><span class="string">  query MyTodoAppQuery &#123;</span></div><div class="line"><span class="string">    todos &#123;</span></div><div class="line"><span class="string">      id</span></div><div class="line"><span class="string">      text</span></div><div class="line"><span class="string">      completed</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  &#125;</span></div><div class="line"><span class="string">`</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> data = client.readQuery(&#123; query &#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> myNewTodo = &#123;</div><div class="line">  id: <span class="string">'6'</span>,</div><div class="line">  text: <span class="string">'Start using Apollo Client.'</span>,</div><div class="line">  completed: <span class="literal">false</span>,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">client.writeQuery(&#123;</div><div class="line">  query,</div><div class="line">  data: &#123;</div><div class="line">    todos: [...data.todos, myNewTodo],</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>Resources:</strong></p>
<ul>
<li><a href="apollo-client-api.html#ApolloClient.watchQuery"><code>ApolloClient#watchQuery</code> API documentation</a></li>
<li><a href="apollo-client-api.html#ApolloClient.writeQuery"><code>ApolloClient#writeQuery</code> API documentation</a></li>
<li><a href="apollo-client-api.html#ApolloClient.writeFragment"><code>ApolloClient#writeFragment</code> API documentation</a></li>
<li><a href="apollo-client-api.html#ApolloClient.writeQuery"><code>DataProxy#writeQuery</code> API documentation</a></li>
<li><a href="apollo-client-api.html#ApolloClient.writeFragment"><code>DataProxy#writeFragment</code> API documentation</a></li>
</ul>
<h2 id="updating-the-cache-after-a-mutation">Updating the cache after a mutation</h2>

<p>Being able to read and write to the Apollo cache from anywhere in your application gives you a lot of power over your data. However, there is one place where we most often want to update our cached data: after a mutation. As such, Apollo Client has optimized the experience for updating your cache with the read and write methods after a mutation with the <code>update</code> function. Let us say that we have the following GraphQL mutation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mutation TodoCreateMutation($text: String!) &#123;</div><div class="line">  createTodo(text: $text) &#123;</div><div class="line">    id</div><div class="line">    text</div><div class="line">    completed</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We may also have the following GraphQL query:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">query TodoAppQuery &#123;</div><div class="line">  todos &#123;</div><div class="line">    id</div><div class="line">    text</div><div class="line">    completed</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>At the end of our mutation we want our query to include the new todo like we had sent our <code>TodoAppQuery</code> a second time after the mutation finished without actually sending the query. To do this we can use the <code>update</code> function provided as an option of the <code>client.mutate</code> method. To update your cache with the mutation just write code that looks like:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// We assume that the GraphQL operations `TodoCreateMutation` and</span></div><div class="line"><span class="comment">// `TodoAppQuery` have already been defined using the `gql` tag.</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> text = <span class="string">'Hello, world!'</span>;</div><div class="line"></div><div class="line">client.mutate(&#123;</div><div class="line">  mutation: TodoCreateMutation,</div><div class="line">  variables: &#123;</div><div class="line">    text,</div><div class="line">  &#125;,</div><div class="line">  update: <span class="function">(<span class="params">proxy, &#123; data: &#123; createTodo &#125; &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// Read the data from our cache for this query.</span></div><div class="line">    <span class="keyword">const</span> data = proxy.readQuery(&#123; <span class="attr">query</span>: TodoAppQuery &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// Add our todo from the mutation to the end.</span></div><div class="line">    data.todos.push(createTodo);</div><div class="line"></div><div class="line">    <span class="comment">// Write our data back to the cache.</span></div><div class="line">    proxy.writeQuery(&#123; <span class="attr">query</span>: TodoAppQuery, data &#125;);</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The first <code>proxy</code> argument is an instance of <a href="apollo-client-api.html#DataProxy"><code>DataProxy</code></a> has the same for methods that we just learned exist on the Apollo Client: <code>readQuery</code>, <code>readFragment</code>, <code>writeQuery</code>, and <code>writeFragment</code>. The reason we call them on a <code>proxy</code> object here instead of on our <code>client</code> instance is that we can easily apply optimistic updates (which we will demonstrate in a bit). The <code>proxy</code> object also provides an isolated transaction which shields you from any other mutations going on at the same time, and the <code>proxy</code> object also batches writes together until the very end.</p>
<p>If you provide an <code>optimisticResponse</code> option to the mutation then the <code>update</code> function will be run twice. Once immediately after you call <code>client.mutate</code> with the data from <code>optimisticResponse</code>. After the mutation successfully executes against the server the changes made in the first call to <code>update</code> will be rolled back and <code>update</code> will be called with the <em>actual</em> data returned by the mutation and not just the optimistic response.</p>
<p>Putting it all together:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> text = <span class="string">'Hello, world!'</span>;</div><div class="line"></div><div class="line">client.mutate(&#123;</div><div class="line">  mutation: TodoCreateMutation,</div><div class="line">  variables: &#123;</div><div class="line">    text,</div><div class="line">  &#125;,</div><div class="line">  optimisticResponse: &#123;</div><div class="line">    id: <span class="number">-1</span>, <span class="comment">// -1 is a temporary id for the optimistic response.</span></div><div class="line">    text,</div><div class="line">    completed: <span class="literal">false</span>,</div><div class="line">  &#125;,</div><div class="line">  update: <span class="function">(<span class="params">proxy, &#123; data: &#123; createTodo &#125; &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> data = proxy.readQuery(&#123; <span class="attr">query</span>: TodoAppQuery &#125;);</div><div class="line">    data.todos.push(createTodo);</div><div class="line">    proxy.writeQuery(&#123; <span class="attr">query</span>: TodoAppQuery, data &#125;);</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>As you can see the <code>update</code> function on <code>client.mutate</code> provides extra change management functionality specific to the use case of a mutation while still providing you the powerful data control APIs that are available on <code>client</code>.</p>
<p>The <code>update</code> function is not a good place for side-effects as it may be called multiple times. Also, you may not call any of the methods on <code>proxy</code> asynchronously.</p>
<p><strong>Resources:</strong></p>
<ul>
<li><a href="apollo-client-api.html#ApolloClient.mutate"><code>ApolloClient#mutate</code> API documentation</a></li>
<li><a href="apollo-client-api.html#DataProxy"><code>DataProxy</code> API documentation</a></li>
</ul>

    </div>
  </div>

  <div class="pagination">
    <div class="content-wrapper">
      
      
        <a class="link primary prev"
          href="changelog.html">
          <span class="icon-arrow-left-alt"></span>
          <span class="subtitle-pagination">Previous</span>
          Changelog
        </a>
      
      
        <a class="link primary next"
          href="developer-tooling.html">
          <span class="subtitle-pagination">Next</span>
          Developer tools
          <span class="icon-arrow-right-alt"></span>
        </a>
      
    </div>
  </div>

  <div class="github">
    <a class="link tertiary " href="https://github.com/apollographql/apollo-client/tree/master/docs/source/features/caching.md" target="_blank">
      <span class="icon-github"></span>Edit on GitHub</a>
  </div>

  
</div>

    <script src="/docs/react/script/smooth-scroll.min.js"></script>
    <script src="/docs/react/script/main.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

    <script>
      // nectar ninja
      (function(){
        var handle = '@meteorjs';
        var a = document.createElement('script');
        var m = document.getElementsByTagName('script')[0];
        a.async = 1;
        a.src = 'https://nectar.ninja/api/v1/' + handle.slice(1);
        m.parentNode.insertBefore(a, m);
      })();

     

      
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-PNFDVBB');
      

      
        // Segment Tracking
        !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
        analytics.load("wgrIo8Bul0Ujl8USETG3DB6hONdy4kTg");
        analytics.page()
        }}();
      

      // search box
      

      
    </script>
  </body>
</html>
