<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <!-- Basic -->
    <title>Network layer | Apollo Client Guide</title>
    <meta name="description" content="How to configure Apollo Client's network layer, or build your own.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="images/favicon.png" sizes="16x16 32x32 64x64">

    <!-- Social -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://www.apollographql.com/docs/react">
    <meta property="og:title" content="Network layer | Apollo Client Guide">
    <meta property="og:description" content="How to configure Apollo Client's network layer, or build your own.">
    <meta property="og:image" content="">
    <meta name="twitter:card" content="summary_image_large">
    <meta name="twitter:site" content="@apollographql">
    <meta name="twitter:title" content="Network layer | Apollo Client Guide">
    <meta name="twitter:description" content="How to configure Apollo Client's network layer, or build your own.">
    <meta name="twitter:image" content="">

    <!-- Misc -->
    <meta name="google-site-verification" content="" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,300italic,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/docs/react/style/style.css">
  </head>
  <body class="">
    

<div class="nav dark">
  <div class="nav-group">
    <div class="nav-item show-mobile">
      <span class="js-sidebar-toggle ">
        <span class="icon-menu"></span>
      </span>
    </div>
    <div class="nav-item">
      
      <a class="logo-wrapper" href="http://dev.apollodata.com/" title="Apollo Developers"  >
        <img src="../images/logo-apollo-space-left.svg" alt="Apollo" class="logo"/><img src="../images/logo-apollo-subbrands-developers-space.svg" class="logo-subbrand" alt="Developers"/>
      </a>
    </div>
  </div>

  <div class="nav-group right">
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/react"  >
          <span>React</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/angular2"  >
          <span>Angular</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/ios"  >
          <span>iOS</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/android"  >
          <span>Android</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/core"  >
          <span>Vanilla JS</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false separator">
        <a class="link" href="http://dev.apollodata.com/tools"  >
          <span>Server</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="https://medium.com/apollo-stack" target=_new >
          <span>Blog</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://dev.apollodata.com/community"  >
          <span>Community</span>
        </a>
      </div>
    
  </div>
</div>

<div class="sidebar">
  <div class="panel">
    <div class="panel-item">
      <a class="" href="../http:/dev.apollodata.com/" title="Apollo"  >
        <span>Apollo Developers</span>
      </a>
    </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/react"  >
          <span>React</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/angular2"  >
          <span>Angular</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/ios"  >
          <span>iOS</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/android"  >
          <span>Android</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/core"  >
          <span>Vanilla JS</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/tools"  >
          <span>Server</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="https://medium.com/apollo-stack" target=_new >
          <span>Blog</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://dev.apollodata.com/community"  >
          <span>Community</span>
        </a>
      </div>
    
  </div>

  <div class="sidebar-content">
    <div class="topcap">
      <span class="title-sidebar">Apollo Client Guide</span>
      
    </div>

    

    <ul class="toc">
      
        <li>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../index.html" class="sidebar-link ">
                  <span>Apollo Client</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="integrations.html" class="sidebar-link ">
                  <span>View Integrations</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="setup.html" class="sidebar-link ">
                  <span>Setup and options</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="queries.html" class="sidebar-link ">
                  <span>Queries</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="mutations.html" class="sidebar-link ">
                  <span>Mutations</span>
                </a>
              </li>
            
              
              <li class="item-toc  current">
                <a href="" class="sidebar-link  current">
                  <span>Network layer</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="error-handling.html" class="sidebar-link ">
                  <span>Error Handling</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="fragments.html" class="sidebar-link ">
                  <span>Using Fragments</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="subscriptions.html" class="sidebar-link ">
                  <span>Subscriptions</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Features</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../features/changelog.html" class="sidebar-link ">
                  <span>Changelog</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../features/caching.html" class="sidebar-link ">
                  <span>Direct Cache Access</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../features/developer-tooling.html" class="sidebar-link ">
                  <span>Developer tools</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../features/network-customization.html" class="sidebar-link ">
                  <span></span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../features/optimistic-ui.html" class="sidebar-link ">
                  <span>Optimistic UI</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../features/react-native.html" class="sidebar-link ">
                  <span>Integrating with React Native</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../features/static-typing.html" class="sidebar-link ">
                  <span>Using TypeScript and Flow</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Recipes</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../recipes/authentication.html" class="sidebar-link ">
                  <span>Authentication</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/babel.html" class="sidebar-link ">
                  <span>Precompilation with babel</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/meteor.html" class="sidebar-link ">
                  <span>Meteor</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/pagination.html" class="sidebar-link ">
                  <span>Pagination</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/prefetching.html" class="sidebar-link ">
                  <span>Prefetching data</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/query-splitting.html" class="sidebar-link ">
                  <span>Query Splitting</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/server-side-rendering.html" class="sidebar-link ">
                  <span>Server Side Rendering</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/simple-example.html" class="sidebar-link ">
                  <span>Small Example: Snack</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../recipes/webpack.html" class="sidebar-link ">
                  <span>Webpack loader</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Reference</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../reference/index.html" class="sidebar-link ">
                  <span>Title</span>
                </a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </div>
</div>

<div class="content">
  <div class="content-wrapper">
    <div class="header-content">
      <h1 class="title-page">Network layer</h1>
      
        <div class="subtitle-page">How to configure Apollo Client's network layer, or build your own.</div>
      

      <div class="page-actions">
        <div class="actions-group">
          <a class="btn tertiary small round lowercase" href="https://github.com/apollographql/apollo-client/tree/master/docs/source/basics/network-layer.md" target="_blank"><span class="icon-github"></span> <span>Edit on GitHub</span></a>
          
          
        </div>
      </div>
    </div>

    <div class="document-formatting">
      <h2 id="network-interfaces">Network interfaces</h2>

<p>Apollo Client has a pluggable network interface layer, which can let you configure how queries are sent over HTTP, or replace the whole network part with something completely custom, like a websocket transport, mocked server data, or anything else you can imagine.</p>
<h3 id="createNetworkInterface" title="createNetworkInterface">Creating a network interface</h3>

<p>To create a network interface, use <a href="apollo-client-api.html#createNetworkInterface"><code>createNetworkInterface</code></a>.</p>
<p>Here’s how you would instantiate a new client with a custom endpoint URL:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ApolloClient, &#123; createNetworkInterface &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> networkInterface = createNetworkInterface(&#123; <span class="attr">uri</span>: <span class="string">'https://example.com/graphql'</span> &#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  networkInterface,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>And if you needed to pass additional options to <a href="https://github.github.io/fetch/" target="_blank" rel="external"><code>fetch</code></a>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ApolloClient, &#123; createNetworkInterface &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> networkInterface = createNetworkInterface(&#123;</div><div class="line">  uri: <span class="string">'https://example.com/graphql'</span>,</div><div class="line">  opts: &#123;</div><div class="line">    <span class="comment">// Additional fetch options like `credentials` or `headers`</span></div><div class="line">    credentials: <span class="string">'same-origin'</span>,</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  networkInterface,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="networkInterfaceMiddleware" title="Middleware">Middleware</h3>

<p>It is possible to use middleware with the network interface created via <code>createNetworkInterface</code>. Middleware is used to inspect and modify every request made over the <code>netWorkInterface</code>, for example, adding authentication tokens to every query. In order to add middleware, you must pass an array of objects into the interface created with <code>createNetworkInterface()</code>.  Each object must contain an <code>applyMiddleware</code> method with the following parameters:</p>
<ul>
<li><code>req: object</code> The HTTP request being processed by the middleware.</li>
<li><code>next: function</code> This function pushes the HTTP request onward through the middleware.</li>
</ul>
<p>The <code>req</code> object contains the options from the <code>createNetworkInterface</code> definition, but you can pass extra options to the request by using the <code>req.options</code> object.</p>
<p>The following example shows how you’d create a middleware.  It can be done either by providing the required object directly to <code>.use()</code> or by creating an object and passing it to <code>.use()</code>. In both cases all middleware objects have to be wrapped inside an array.</p>
<p>In both examples, we’ll show how you would add an authentication token to the HTTP header of the requests being sent by the client.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ApolloClient, &#123; createNetworkInterface &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> networkInterface = createNetworkInterface(&#123; <span class="attr">uri</span>: <span class="string">'/graphql'</span> &#125;);</div><div class="line"></div><div class="line">networkInterface.use([&#123;</div><div class="line">  applyMiddleware(req, next) &#123;</div><div class="line">    <span class="keyword">if</span> (!req.options.headers) &#123;</div><div class="line">      req.options.headers = &#123;&#125;;  <span class="comment">// Create the header object if needed.</span></div><div class="line">    &#125;</div><div class="line">    req.options.headers[<span class="string">'authorization'</span>] = localStorage.getItem(<span class="string">'token'</span>) ? localStorage.getItem(<span class="string">'token'</span>) : <span class="literal">null</span>;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;]);</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  networkInterface,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The above example shows the use of a single middleware passed directly to <code>.use()</code>. It checks to see if we have a token (JWT, for example) and passes that token into the HTTP header of the request, so we can authenticate interactions with GraphQL performed through our network interface.</p>
<p>The following example shows the use of multiple middlewares passed as an array:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ApolloClient, &#123; createNetworkInterface &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> networkInterface = createNetworkInterface(&#123; <span class="attr">uri</span>: <span class="string">'/graphql'</span> &#125;);</div><div class="line"><span class="keyword">const</span> token = <span class="string">'first-token-value'</span>;</div><div class="line"><span class="keyword">const</span> token2 = <span class="string">'second-token-value'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> exampleWare1 = &#123;</div><div class="line">  applyMiddleware(req, next) &#123;</div><div class="line">    <span class="keyword">if</span> (!req.options.headers) &#123;</div><div class="line">      req.options.headers = &#123;&#125;;  <span class="comment">// Create the headers object if needed.</span></div><div class="line">    &#125;</div><div class="line">    req.options.headers[<span class="string">'authorization'</span>] = token;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> exampleWare2 = &#123;</div><div class="line">  applyMiddleware(req, next) &#123;</div><div class="line">    <span class="keyword">if</span> (!req.options.headers) &#123;</div><div class="line">      req.options.headers = &#123;&#125;;  <span class="comment">// Create the headers object if needed.</span></div><div class="line">    &#125;</div><div class="line">    req.options.headers[<span class="string">'authorization'</span>] = token2;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">networkInterface.use([exampleWare1, exampleWare2]);</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  networkInterface,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Given the above code, the header’s <code>Authorization</code> value will be that of <code>token2</code>.  This example shows how you can use more than one middleware to make multiple/separate modifications to the request being processed in the form of a chain.  This example doesn’t show the use of <code>localStorage</code>, but is instead just meant to demonstrate the use of more than one middleware, passed to <code>.use()</code> as an array.</p>
<h3 id="networkInterfaceAfterware" title="Afterware">Afterware</h3>

<p>‘Afterware’ is very similar to a middleware, except that an afterware runs after a request has been made,<br>that is when a response is going to get processed. It’s perfect for responding to the situation where a user becomes logged out during their session.</p>
<p>It is possible to use afterware with the network interface created via <code>createNetworkInterface</code>.<br>In order to do so, you must pass an array of objects into the interface created with <code>createNetworkInterface()</code>.<br>Each object must contain an <code>applyAfterware</code> method with the following parameters:</p>
<ul>
<li><code>{ response }: object</code> An object containing the HTTP response of a GraphQL fetch.</li>
<li><code>next: function</code> This function pushes the HTTP response onward through the afterware.</li>
</ul>
<p>The following example demonstrates how to implement an afterware function.<br>It can be done either by providing the required object directly to <code>.useAfter()</code><br>or by creating an object and passing it to <code>.useAfter()</code>.<br>In both cases all afterware objects have to be wrapped inside an array.</p>
<p>Below are some examples of using afterwares.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ApolloClient, &#123; createNetworkInterface &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"><span class="keyword">import</span> &#123;logout&#125; <span class="keyword">from</span> <span class="string">'./logout'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> networkInterface = createNetworkInterface(&#123; <span class="attr">uri</span>: <span class="string">'/graphql'</span> &#125;);</div><div class="line"></div><div class="line">networkInterface.useAfter([&#123;</div><div class="line">  applyAfterware(&#123; response &#125;, next) &#123;</div><div class="line">    <span class="keyword">if</span> (response.status === <span class="number">401</span>) &#123;</div><div class="line">      logout();</div><div class="line">    &#125;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;]);</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  networkInterface,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The above example shows the use of a single afterware passed directly to <code>.useAfter()</code>.<br>It checks to see if the response status code is equal to 401 and if it is then we will<br>logout the user from the application.</p>
<p>The following example shows the use of multiple afterwares passed as an array:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ApolloClient, &#123; createNetworkInterface &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"><span class="keyword">import</span> &#123;redirectTo&#125; <span class="keyword">from</span> <span class="string">'./redirect'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> networkInterface = createNetworkInterface(&#123; <span class="attr">uri</span>: <span class="string">'/graphql'</span> &#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> exampleWare1 = &#123;</div><div class="line">  applyAfterware(&#123; response &#125;, next) &#123;</div><div class="line">    <span class="keyword">if</span> (response.status === <span class="number">500</span>) &#123;</div><div class="line">      <span class="built_in">console</span>.error(<span class="string">'Server returned an error'</span>);</div><div class="line">    &#125;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> exampleWare2 = &#123;</div><div class="line">  applyAfterware(&#123; response &#125;, next) &#123;</div><div class="line">    <span class="keyword">if</span> (response.status === <span class="number">200</span>) &#123;</div><div class="line">      redirectTo(<span class="string">'/'</span>);</div><div class="line">    &#125;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">networkInterface.useAfter([exampleWare1, exampleWare2]);</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  networkInterface,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This example shows how you can use more than one afterware to make multiple/separate<br>modifications to the response being processed in the form of a chain.</p>
<h3 id="networkInterfaceChaining" title="Chaining">Chaining</h3>

<p>It is possible to build a chain made of <code>.use()</code> and <code>.useAfter()</code> calls in any order :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">networkInterface.use([exampleWare1])</div><div class="line">  .use([exampleWare2])</div><div class="line">  .useAfter([exampleWare3])</div><div class="line">  .useAfter([exampleWare4])</div><div class="line">  .use([exampleWare5]);</div></pre></td></tr></table></figure>
<h2 id="websocket">GraphQL over WebSocket</h2>

<p>Another alternative for network interface is GraphQL over WebSocket, using <a href="https://github.com/apollographql/subscriptions-transport-ws/" target="_blank" rel="external"><code>subscriptions-transport-ws</code></a>.</p>
<p>You can the create WebSocket as full-transport, and pass all GraphQL operations over the WebSocket (<code>Query</code>, <code>Mutation</code> and <code>Subscription</code>), or use a hybrid network interface and execute <code>Query</code> and <code>Mutation</code> over HTTP, and only <code>Subscription</code> over the WebSocket.</p>
<h3 id="full-websocket">Full WebSocket</h3>

<p>To start with full WebSocket, use <code>subscriptions-transport-ws</code> and create your <a href="/tools/#GraphQL-subscriptions">GraphQL subscriptions server</a>.</p>
<p>Then, configure you client side by creating an instance of <code>SubscriptionClient</code>, and use the created instance and your network interface:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; SubscriptionClient &#125; <span class="keyword">from</span> <span class="string">'subscriptions-transport-ws'</span>;</div><div class="line"><span class="keyword">import</span> ApolloClient <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> GRAPHQL_ENDPOINT = <span class="string">'ws://localhost:3000/graphql'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> SubscriptionClient(GRAPHQL_ENDPOINT, &#123;</div><div class="line">  reconnect: <span class="literal">true</span>,</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> apolloClient = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">    networkInterface: client,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="hybrid-websocket">Hybrid WebSocket</h3>

<p>To use WebSocket for subscriptions only, create your regular network interface for queries and mutation, and create an instanace of <code>SubscriptionClient</code></p>
<p>Then, use <code>addGraphQLSubscriptions</code> to combine the two into a single hybrid network interface:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;SubscriptionClient, addGraphQLSubscriptions&#125; <span class="keyword">from</span> <span class="string">'subscriptions-transport-ws'</span>;</div><div class="line"><span class="keyword">import</span> ApolloClient, &#123;createNetworkInterface&#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="comment">// Create regular NetworkInterface by using apollo-client's API:</span></div><div class="line"><span class="keyword">const</span> networkInterface = createNetworkInterface(&#123;</div><div class="line"> uri: <span class="string">'http://localhost:3000'</span> <span class="comment">// Your GraphQL endpoint</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// Create WebSocket client</span></div><div class="line"><span class="keyword">const</span> wsClient = <span class="keyword">new</span> SubscriptionClient(<span class="string">`ws://localhost:5000/`</span>, &#123;</div><div class="line">    reconnect: <span class="literal">true</span>,</div><div class="line">    connectionParams: &#123;</div><div class="line">        <span class="comment">// Pass any arguments you want for initialization</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// Extend the network interface with the WebSocket</span></div><div class="line"><span class="keyword">const</span> networkInterfaceWithSubscriptions = addGraphQLSubscriptions(</div><div class="line">    networkInterface,</div><div class="line">    wsClient</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">// Finally, create your ApolloClient instance with the modified network interface</span></div><div class="line"><span class="keyword">const</span> apolloClient = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">    networkInterface: networkInterfaceWithSubscriptions</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="custom-network-interface">Custom network interface</h2>

<p>You can define a custom network interface and pass it to the Apollo Client to send your queries in a different way. You might want to do this for a variety of reasons:</p>
<ol>
<li>You want a custom transport that sends queries over Websockets instead of HTTP</li>
<li>You want to modify the query or variables before they are sent</li>
<li>You want to run your app against a mocked client-side schema and never send any network requests at all</li>
</ol>
<p>All you need to do is create a <code>NetworkInterface</code> and pass it to the <code>ApolloClient</code> constructor.</p>
<h3 id="NetworkInterface"><i>interface</i> NetworkInterface</h3>

<p>This is the interface that an object should implement so that it can be used by the Apollo Client to make queries.</p>
<ul>
<li><code>query(request: Request): Promise&lt;ExecutionResult&gt;</code> This function on your network interface is pretty self-explanatory - it takes a GraphQL request object, and should return a promise for a GraphQL result. The promise should be rejected in the case of a network error.</li>
</ul>
<h3 id="Request"><i>interface</i> Request</h3>

<p>Represents a request passed to the network interface. Has the following properties:</p>
<ul>
<li><code>query: Object</code> AST of the query to send to the server. You can get stringify this value by using <code>print</code> function from <code>graphql/language/printer</code> package.</li>
<li><code>variables: Object</code> The variables to send with the query.</li>
<li><code>operationName: string</code> An optional parameter that will be included in error messages about this query.</li>
</ul>
<h3 id="ExecutionResult"><i>interface</i> ExecutionResult</h3>

<p>This represents a result that comes back from the GraphQL server.</p>
<ul>
<li><code>data: any</code> This is the actual data returned by the server.</li>
<li><code>errors: Array</code> This is an array of errors returned by the server.</li>
</ul>
<h3 id="CustomNetworkInterfaceExample">Example</h3>

<p>To illustrate how you would define your own custom network interface, this is a code example of a <i>HybridNetworkInterface</i>. What this custom network interface does is batch requests by default, but allows a programmer to opt certain queries out of the batch queue and make direct requests instead. This might be valuable for particularly urgent requests that shouldn’t be batched with slower queries and delayed by the batch interval poll time.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* @flow */</span></div><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  createBatchingNetworkInterface,</div><div class="line">  createNetworkInterface,</div><div class="line">  HTTPBatchedNetworkInterface,</div><div class="line">  HTTPFetchNetworkInterface,</div><div class="line">  Request,</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; ExecutionResult &#125; <span class="keyword">from</span> <span class="string">'graphql'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HTTPHybridNetworkInterface</span> </span>&#123;</div><div class="line">  batchedInterface: HTTPBatchedNetworkInterface;</div><div class="line">  networkInterface: HTTPFetchNetworkInterface;</div><div class="line"></div><div class="line">  <span class="keyword">constructor</span>(opts: Object) &#123;</div><div class="line">    <span class="keyword">this</span>.batchedInterface = createBatchingNetworkInterface(opts);</div><div class="line">    <span class="keyword">this</span>.networkInterface = createNetworkInterface(opts);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  query(request: Request): <span class="built_in">Promise</span>&lt;ExecutionResult&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (request.variables &amp;&amp; request.variables.__disableBatch) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.networkInterface.query(request);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.batchedInterface.query(request);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  use(middlewares: <span class="built_in">Array</span>&lt;*&gt;) &#123;</div><div class="line">    <span class="keyword">this</span>.networkInterface.use(middlewares);</div><div class="line">    <span class="keyword">this</span>.batchedInterface.use(middlewares);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  useAfter(afterwares: <span class="built_in">Array</span>&lt;*&gt;) &#123;</div><div class="line">    <span class="keyword">this</span>.networkInterface.useAfter(afterwares);</div><div class="line">    <span class="keyword">this</span>.batchedInterface.useAfter(afterwares);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createHybridNetworkInterface</span>(<span class="params">opts: Object</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HTTPHybridNetworkInterface(opts);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You can pass arbitrary data into your network interface using variables. In this example, any request can be made to skip the batch by setting the variable <code>__disableBatch</code> on the request.</p>
<h2 id="query-batching">Query batching</h2>


<p>Apollo lets you automatically batch multiple queries into one request when they are made within a certain interval. This means that if you render several components, for example a navbar, sidebar, and content, and each of those do their own GraphQL query, they will all be sent in one roundtrip. Batching works only with server that support batched queries (for example <a href="https://github.com/apollostack/graphql-server" target="_blank" rel="external">graphql-server</a>). Batched requests to servers that don’t support batching will fail.</p>
<p>To use batching, simply pass a <code>BatchedNetworkInterface</code> to the <code>ApolloClient</code> constructor. You can do so by using  <code>createBatchingNetworkInterface</code> instead of <code>createNetworkInterface</code>. <code>createBatchingNetworkInterface</code> takes a single options object (the same as <code>createNetworkInterface</code>) with an additional <code>batchInterval</code> option, which determines how long (in milliseconds) the network interface batches up queries before sending them to the server. You can also provide the <code>batchMax</code> option to define the maximum amount of queries you want in one batch. When left empty this will send all queries within the <code>batchInterval</code> in one batch.</p>
<h3 id="BatchingExample">Query batching example</h3>

<p>This example shows how to create the <code>BatchedNetworkInterface</code> that you’ll pass to the <code>ApolloClient</code> constructor:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ApolloClient, &#123; createBatchingNetworkInterface &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> batchingNetworkInterface = createBatchingNetworkInterface(&#123;</div><div class="line">  uri: <span class="string">'localhost:3000'</span>,</div><div class="line">  batchInterval: <span class="number">10</span>,  <span class="comment">// in milliseconds</span></div><div class="line">  batchMax: <span class="number">10</span>,</div><div class="line">  opts: &#123;</div><div class="line">    <span class="comment">// Options to pass along to `fetch`</span></div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> apolloClient = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  networkInterface: batchingNetworkInterface,</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// These two queries happen in quick succession, possibly in totally different</span></div><div class="line"><span class="comment">// places within your UI.</span></div><div class="line">apolloClient.query(&#123; <span class="attr">query</span>: firstQuery &#125;);</div><div class="line">apolloClient.query(&#123; <span class="attr">query</span>: secondQuery &#125;);</div><div class="line"></div><div class="line"><span class="comment">// You don't have to do anything special - Apollo will send the two queries as one request.</span></div></pre></td></tr></table></figure>
<p></p><h3 id="BatchingExplained">How query batching works</h3><br>Query batching is a transport-level mechanism that works only with servers that support it (for example, Apollo’s <a href="https://github.com/apollostack/graphql-server" target="_blank" rel="external">graphql-server</a>). Requests to servers that don’t support transport batching will fail. If transport batching is turned on, multiple requests are batched together in an array:<p></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[&#123;</div><div class="line">   query: `query Query1 &#123; someField &#125;`,</div><div class="line">   variables: &#123;&#125;,</div><div class="line">   operationName: <span class="symbol">'Query1</span>',</div><div class="line"> &#125;,</div><div class="line"> &#123;</div><div class="line">   query: `query Query2 (<span class="name">$num:</span> Int)&#123; plusOne(<span class="name">num:</span> $num) &#125;`,</div><div class="line">   variables: &#123; num: <span class="number">3</span> &#125;,</div><div class="line">   operationName: <span class="symbol">'Query2</span>',</div><div class="line"> &#125;]</div></pre></td></tr></table></figure>
 <h2 id="query-deduplication">Query deduplication</h2><br> Query deduplication can help reduce the number of queries that are sent over the wire. It is turned on by default, but can be turned off by passing <code>queryDeduplication: false</code> to the Apollo Client constructor. If turned on, query deduplication happens before the query hits the network layer.<br><br> Query deduplication can be useful if many components display the same data, but you don’t want to fetch that data from the server many times. It works by comparing a query to all queries currently in flight. If an identical query is currently in flight, the new query will be mapped to the same promise and resolved when the currently in-flight query returns.<br><br> <h2 id="query-batch-wares">Middleware and Afterware for batching network interfaces</h2>

<p>In a batching network interface middlewares and afterwares do not run once per query but instead run once per batch request. Creating middleware and afterware for a batching network interface is very similar as standard middleware and afterware except instead of <code>applyMiddleware</code> and <code>applyAfterware</code>, you want to use <code>applyBatchMiddleware</code> and <code>applyBatchAfterware</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ApolloClient, &#123; createBatchingNetworkInterface &#125; <span class="keyword">from</span> <span class="string">'apollo-client'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> networkInterface = createBatchingNetworkInterface(&#123;</div><div class="line">  uri: <span class="string">'localhost:3000'</span>,</div><div class="line">  batchInterval: <span class="number">10</span>,</div><div class="line">  opts: &#123;</div><div class="line">   <span class="comment">// Options to pass along to `fetch`</span></div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> token = <span class="string">'first-token-value'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> authMiddleware = &#123;</div><div class="line">  applyBatchMiddleware(req, next) &#123;</div><div class="line">    <span class="keyword">if</span> (!req.options.headers) &#123;</div><div class="line">      req.options.headers = &#123;&#125;;  <span class="comment">// Create the headers object if needed.</span></div><div class="line">    &#125;</div><div class="line">    req.options.headers[<span class="string">'authorization'</span>] = token;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> loggingAfterware = &#123;</div><div class="line">  applyBatchAfterware(res, next) &#123;</div><div class="line">    <span class="built_in">console</span>.log(res.responses);</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">networkInterface.use([authMiddleware]);</div><div class="line">networkInterface.useAfter([loggingAfterware]);</div><div class="line"></div><div class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  networkInterface,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>

    </div>
  </div>

  <div class="pagination">
    <div class="content-wrapper">
      
      
        <a class="link primary prev"
          href="mutations.html">
          <span class="icon-arrow-left-alt"></span>
          <span class="subtitle-pagination">Previous</span>
          Mutations
        </a>
      
      
        <a class="link primary next"
          href="error-handling.html">
          <span class="subtitle-pagination">Next</span>
          Error Handling
          <span class="icon-arrow-right-alt"></span>
        </a>
      
    </div>
  </div>

  <div class="github">
    <a class="link tertiary " href="https://github.com/apollographql/apollo-client/tree/master/docs/source/basics/network-layer.md" target="_blank">
      <span class="icon-github"></span>Edit on GitHub</a>
  </div>

  
</div>

    <script src="/docs/react/script/smooth-scroll.min.js"></script>
    <script src="/docs/react/script/main.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

    <script>
      // nectar ninja
      (function(){
        var handle = '@meteorjs';
        var a = document.createElement('script');
        var m = document.getElementsByTagName('script')[0];
        a.async = 1;
        a.src = 'https://nectar.ninja/api/v1/' + handle.slice(1);
        m.parentNode.insertBefore(a, m);
      })();

     

      
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-PNFDVBB');
      

      
        // Segment Tracking
        !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
        analytics.load("wgrIo8Bul0Ujl8USETG3DB6hONdy4kTg");
        analytics.page()
        }}();
      

      // search box
      

      
    </script>
  </body>
</html>
